const DOMAINS=["https://static-sg-apse1-primary-mirror-aws-s3-cloudfront-public-cdn.dahi.edu.eu.org","https://static-sg-apse1-primary-mirror-aws-s3-cloudfront-public-cdn.dahi.edu.eu.org.cdn.cloudflare.net","https://tencent.api-data-abtest-config.dahi.edu.eu.org","https://api-data-aws-abtest-config.dahi.edu.eu.org","https://abtest-ch-snssdk-os.netlify.app"],CONFIG={testTimeout:2e3,testCount:3,cacheDays:3,cacheKey:"gfork_fastest_domain",ipTimeout:3e3,cacheTimeout:2e3,initTimeout:1e3,debugMode:!1,showProgressOnly:!0};let testResults=[],userIP=null,appContainer=null,debugVisible=!1,startTime=Date.now(),autoRefreshTimer=null,progressBar=null;const delay=e=>new Promise((s=>setTimeout(s,e))),formatDomain=e=>e.replace("https://","");function getPathFromHash(e){return e&&e.startsWith("#/")?e.substring(2):null}async function fetchUserIP(){try{updateProgress(5,"获取IP中...");const e=new AbortController,s=setTimeout((()=>e.abort()),CONFIG.ipTimeout),t=await fetch("https://www.cloudflare.com/cdn-cgi/trace",{signal:e.signal});clearTimeout(s);const a=await t.text();for(const e of a.split("\n"))if(e.startsWith("ip=")){userIP=e.split("=")[1].trim();break}updateProgress(10,"IP获取完成")}catch(e){console.error("Failed to fetch IP:",e),updateProgress(10,"IP获取失败")}}function getCachedFastestDomain(){if(!userIP)return null;try{const e=JSON.parse(localStorage.getItem(CONFIG.cacheKey)||"null");if(!e)return null;const s=e.ip===userIP,t=Date.now()-e.time<=24*CONFIG.cacheDays*60*60*1e3,a=DOMAINS.includes(e.domain);return s&&t&&a?e.domain:(localStorage.removeItem(CONFIG.cacheKey),null)}catch(e){return console.error("Error reading cache:",e),null}}function cacheFastestDomain(e){if(userIP)try{const s={ip:userIP,domain:e,time:Date.now()};localStorage.setItem(CONFIG.cacheKey,JSON.stringify(s))}catch(e){console.error("Error writing cache:",e)}}function updateProgress(e,s=""){if(!progressBar)return;progressBar.style.width=e+"%";const t=document.getElementById("progress-text");t&&(t.textContent=s||`${Math.round(e)}%`)}function createProgressBar(){const e=document.createElement("div");return e.className="progress-container",e.innerHTML='<div class="progress-wrapper"><div id="progress-bar"></div><div id="progress-text">0%</div></div>',progressBar=e.querySelector("#progress-bar"),e}function createDebugButton(){const e=document.createElement("button");e.id="debug-btn",e.innerHTML='<span class="material-icons">bug_report</span>',e.onclick=()=>{debugVisible=!debugVisible;const s=document.getElementById("debug-content");s&&(s.style.display=debugVisible?"block":"none",e.classList.toggle("active",debugVisible))},document.body.appendChild(e)}function startAutoRefresh(){autoRefreshTimer&&clearTimeout(autoRefreshTimer),autoRefreshTimer=setTimeout((()=>{Date.now()-startTime>16e3&&location.reload()}),16100)}async function testDomainConnection(e){return new Promise((s=>{const t=document.createElement("iframe");t.style.display="none",t.sandbox="allow-scripts";const a=setTimeout((()=>{n(),s(!1)}),CONFIG.testTimeout);function n(){clearTimeout(a),t.parentNode&&document.body.removeChild(t)}const i=e=>{"gfork_activated"===e.data&&(n(),window.removeEventListener("message",i),s(!0))};window.addEventListener("message",i);const o=`<!DOCTYPE html><html><head><script>window.gfork_test_active = false;window.onGforkActivated = function() {window.gfork_test_active = true;parent.postMessage('gfork_activated', '*');};const script = document.createElement('script');script.src = '${e}/gfork.js';script.onerror = () => parent.postMessage('gfork_error', '*');setTimeout(() => {if (window.gfork_test_active) {parent.postMessage('gfork_activated', '*');}}, 100);document.head.appendChild(script);<\/script></head></html>`;t.srcdoc=o,document.body.appendChild(t)}))}async function testAllDomains(e){testResults=[];const s=[...DOMAINS].sort((()=>Math.random()-.5)).slice(0,CONFIG.testCount);renderContent(`<div class="icon"><span class="material-icons">speed</span></div><h1>测速中</h1><p class="desc">正在测试节点连接速度，请稍候...</p><div class="url">${e}</div><div class="st" id="st"><div class="st-t">测试节点 (${s.length}个)</div>${s.map((e=>`<div class="st-i" data-d="${e}"><span class="material-icons">pending</span>${formatDomain(e)}<span class="lat">等待中</span></div>`)).join("")}</div><div class="tip">提示：正在随机测试 ${CONFIG.testCount} 个节点</div>`),updateProgress(20,"开始测速");for(let e=0;e<s.length;e++){const t=s[e],a=document.querySelector(`[data-d="${t}"]`);updateProgress(20+60/s.length*e,`测试节点 ${e+1}/${s.length}`),a&&(a.className="st-i",a.innerHTML=`<span class="material-icons">sync</span>${formatDomain(t)}<span class="lat">测试中...</span>`);const n=Date.now(),i=await testDomainConnection(t),o=Date.now()-n;i?(testResults.push({domain:t,latency:o}),a&&(a.className="st-i ok",a.innerHTML=`<span class="material-icons">check_circle</span>${formatDomain(t)}<span class="lat">${o}ms</span>`)):a&&(a.className="st-i fail",a.innerHTML=`<span class="material-icons">cancel</span>${formatDomain(t)}<span class="lat">超时</span>`),e<s.length-1&&await delay(300)}updateProgress(80,"分析结果中"),await handleTestResults(e)}async function handleTestResults(e){if(testResults.length>0){testResults.sort(((e,s)=>e.latency-s.latency));const s=testResults[0];cacheFastestDomain(s.domain),await delay(500);const t=`${s.domain}/scripts/${e}`;updateProgress(90,"准备跳转");renderContent(`<div class="icon ok"><span class="material-icons">check_circle</span></div><h1>验证成功</h1><p class="desc">已选择最快节点，即将自动跳转</p><div class="badge"><span class="material-icons">speed</span>最低延迟 ${s.latency}ms</div><div class="url">${t}</div><div class="st"><div class="st-t">测速结果</div>${testResults.map(((e,s)=>`<div class="st-i ok"><span class="material-icons">${0===s?"emoji_events":"check_circle"}</span>${formatDomain(e.domain)}<span class="lat">${e.latency}ms</span></div>`)).join("")}</div><a href="${t}" class="btn"><span class="material-icons">open_in_new</span>立即前往</a>`),updateProgress(100,"完成"),setTimeout((()=>{location.href=t}),1e3)}else handleTestFailure(e)}function handleTestFailure(e){const s=`${DOMAINS[Math.floor(Math.random()*DOMAINS.length)]}/scripts/${e}`;updateProgress(100,"使用备用方案");renderContent(`<div class="icon err"><span class="material-icons">warning</span></div><h1>使用备用方案</h1><p class="desc">所有节点检测超时，已随机选择一个节点</p><div class="url">${s}</div><a href="${s}" class="btn"><span class="material-icons">open_in_new</span>手动前往</a><div class="tip">若无法访问，请重新整理再试</div>`)}function renderContent(e){if(!appContainer)return;const s=createProgressBar();if(CONFIG.showProgressOnly||!debugVisible){appContainer.innerHTML='<div class="icon"><span class="material-icons">rocket_launch</span></div><h1>正在加速</h1><p class="desc">请稍候，正在为您优化连接...</p>',appContainer.appendChild(s);const t=document.createElement("div");t.id="debug-content",t.style.display="none",t.innerHTML=e,appContainer.appendChild(t)}else{const t=document.createElement("div");t.appendChild(s);const a=document.createElement("div");a.id="debug-content",a.innerHTML=e,t.appendChild(a),appContainer.innerHTML="",appContainer.appendChild(t)}progressBar=document.getElementById("progress-bar")}function showError(e){renderContent(`<div class="icon"><span class="material-icons">link</span></div><h1>脚本下载加速</h1><p class="desc">${e}</p><div class="tip">使用方式：在URL后加上 #/your-script-path.user.js</div>`),updateProgress(0,"等待路径")}async function showCacheVerification(e,s){renderContent(`<div class="icon"><span class="material-icons">verified</span></div><h1>校验中</h1><p class="desc">正在校验缓存节点...</p><div class="url">${e}</div><div class="st"><div class="st-t">缓存节点</div><div class="st-i"><span class="material-icons">cloud_done</span>${formatDomain(s)}</div></div><div class="tip">提示：缓存有效期 ${CONFIG.cacheDays} 天${userIP?` (IP: ${userIP})`:""}</div>`),updateProgress(50,"校验缓存"),await delay(CONFIG.cacheTimeout);const t=`${s}/scripts/${e}`;updateProgress(90,"准备跳转");renderContent(`<div class="icon ok"><span class="material-icons">check_circle</span></div><h1>验证成功</h1><p class="desc">缓存校验通过，即将自动跳转</p><div class="badge"><span class="material-icons">bolt</span>缓存加速</div><div class="url">${t}</div><a href="${t}" class="btn"><span class="material-icons">open_in_new</span>立即前往</a>`),updateProgress(100,"完成"),setTimeout((()=>{location.href=t}),1e3)}async function initializeApp(){appContainer=document.getElementById("app"),startAutoRefresh(),createDebugButton();const e=getPathFromHash(location.hash);if(!e)return void showError("请在URL中添加脚本路径");await fetchUserIP(),updateProgress(15,"检查缓存");const s=getCachedFastestDomain();if(s)return void await showCacheVerification(e,s);renderContent(`<div class="icon"><span class="material-icons">sync</span></div><h1>载入中</h1><p class="desc">正在为您准备最佳连接...</p><div class="url">${e}</div>`),updateProgress(20,"初始化"),await delay(CONFIG.initTimeout),await testAllDomains(e)}(async()=>{await initializeApp()})();