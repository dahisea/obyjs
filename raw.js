const D=["https://static-sg-apse1-primary-mirror-aws-s3-cloudfront-public-cdn.dahi.edu.eu.org","https://static-sg-apse1-primary-mirror-aws-s3-cloudfront-public-cdn.dahi.edu.eu.org.cdn.cloudflare.net","https://tencent.api-data-abtest-config.dahi.edu.eu.org","https://api-data-aws-abtest-config.dahi.edu.eu.org","https://abtest-ch-snssdk-os.netlify.app"],CFG={to:2e3,cnt:3,days:3,key:"gfork_fastest_domain",ipto:3e3,cto:2e3,ito:1e3,debugMode:!1,showProgressOnly:!0};let R=[],IP=null,app=null,debugVisible=!1,startTime=Date.now(),autoRefreshTimer=null,progressBar=null;const $=s=>new Promise((e=>setTimeout(e,s))),dd=s=>s.replace("https://","");function startAutoRefresh(){autoRefreshTimer&&clearTimeout(autoRefreshTimer),autoRefreshTimer=setTimeout((()=>{Date.now()-startTime>6e3&&location.reload()}),6100)}function updateProgress(s,e=""){if(!progressBar)return;progressBar.style.width=s+"%";const t=document.getElementById("progress-text");t&&(t.textContent=e||`${Math.round(s)}%`)}function createDebugButton(){const s=document.createElement("button");s.id="debug-btn",s.innerHTML='<span class="material-icons">bug_report</span>',s.onclick=()=>{debugVisible=!debugVisible;const e=document.getElementById("debug-content");e&&(e.style.display=debugVisible?"block":"none",s.classList.toggle("active",debugVisible))},document.body.appendChild(s)}function createProgressBar(){const s=document.createElement("div");return s.className="progress-container",s.innerHTML='\n<div class="progress-wrapper">\n<div id="progress-bar"></div>\n<div id="progress-text">0%</div>\n</div>\n',progressBar=s.querySelector("#progress-bar"),s}async function getIP(){try{updateProgress(5,"獲取IP中...");const s=new AbortController,e=setTimeout((()=>s.abort()),CFG.ipto),t=await fetch("https://www.cloudflare.com/cdn-cgi/trace",{signal:s.signal});clearTimeout(e);const a=await t.text();for(const s of a.split("\n"))s.startsWith("ip=")&&(IP=s.split("=")[1].trim());updateProgress(10,"IP獲取完成")}catch(s){updateProgress(10,"IP獲取失敗")}}function getPath(s){return s&&s.startsWith("#/")?s.substring(2):null}function getCache(){if(!IP)return null;try{const s=JSON.parse(localStorage.getItem(CFG.key)||"null");return!s||s.ip!==IP||Date.now()-s.time>864e5*CFG.days||!D.includes(s.domain)?(localStorage.removeItem(CFG.key),null):s.domain}catch{return null}}function setCache(s){if(IP)try{localStorage.setItem(CFG.key,JSON.stringify({ip:IP,domain:s,time:Date.now()}))}catch(s){}}async function testDomain(s){return new Promise((e=>{const t=document.createElement("iframe");t.style.display="none",t.sandbox="allow-scripts";const a=setTimeout((()=>{n(),e(!1)}),CFG.to);function n(){clearTimeout(a),t.parentNode&&document.body.removeChild(t)}const i=s=>{"gfork_activated"===s.data&&(n(),window.removeEventListener("message",i),e(!0))};window.addEventListener("message",i),t.srcdoc=`<!DOCTYPE html><html><head><script>window.gfork_test_active=false;window.onGforkActivated=function(){window.gfork_test_active=true;parent.postMessage('gfork_activated','*')};const s=document.createElement('script');s.src='${s}/gfork.js';s.onerror=()=>parent.postMessage('gfork_error','*');setTimeout(()=>{if(window.gfork_test_active)parent.postMessage('gfork_activated','*')},100);document.head.appendChild(s);<\/script></head></html>`,document.body.appendChild(t)}))}async function testAll(s){R=[];const e=[...D].sort((()=>Math.random()-.5)).slice(0,CFG.cnt);render(`<div class="icon"><span class="material-icons">speed</span></div><h1>測速中</h1><p class="desc">正在測試節點連接速度，請稍候...</p><div class="url">${s}</div><div class="st" id="st"><div class="st-t">測試節點 (${e.length}個)</div>${e.map((s=>`<div class="st-i" data-d="${s}"><span class="material-icons">pending</span>${dd(s)}<span class="lat">等待中</span></div>`)).join("")}</div><div class="tip">提示：正在隨機測試 ${CFG.cnt} 個節點</div>`),updateProgress(20,"開始測速");for(let s=0;s<e.length;s++){const t=e[s],a=document.querySelector(`[data-d="${t}"]`);updateProgress(20+60/e.length*s,`測試節點 ${s+1}/${e.length}`),a&&(a.className="st-i",a.innerHTML=`<span class="material-icons">sync</span>${dd(t)}<span class="lat">測試中...</span>`);const n=Date.now(),i=await testDomain(t),r=Date.now()-n;i?(R.push({d:t,lat:r}),a&&(a.className="st-i ok",a.innerHTML=`<span class="material-icons">check_circle</span>${dd(t)}<span class="lat">${r}ms</span>`)):a&&(a.className="st-i fail",a.innerHTML=`<span class="material-icons">cancel</span>${dd(t)}<span class="lat">超時</span>`),s<e.length-1&&await $(300)}if(updateProgress(80,"分析結果中"),R.length>0){R.sort(((s,e)=>s.lat-e.lat));const e=R[0];setCache(e.d),await $(500);const t=`${e.d}/scripts/${s}`;updateProgress(90,"準備跳轉");render(`<div class="icon ok"><span class="material-icons">check_circle</span></div><h1>驗證成功</h1><p class="desc">已選擇最快節點，即將自動跳轉</p><div class="badge"><span class="material-icons">speed</span>最低延遲 ${e.lat}ms</div><div class="url">${t}</div><div class="st"><div class="st-t">測速結果</div>${R.map(((s,e)=>`<div class="st-i ok"><span class="material-icons">${0===e?"emoji_events":"check_circle"}</span>${dd(s.d)}<span class="lat">${s.lat}ms</span></div>`)).join("")}</div><a href="${t}" class="btn"><span class="material-icons">open_in_new</span>立即前往</a>`),updateProgress(100,"完成"),setTimeout((()=>{location.href=t}),1e3)}else{const e=`${D[Math.floor(Math.random()*D.length)]}/scripts/${s}`;updateProgress(100,"使用備用方案");render(`<div class="icon err"><span class="material-icons">warning</span></div><h1>使用備用方案</h1><p class="desc">所有節點檢測超時，已隨機選擇一個節點</p><div class="url">${e}</div><a href="${e}" class="btn"><span class="material-icons">open_in_new</span>手動前往</a><div class="tip">若無法訪問，請重新整理再試</div>`)}}function render(s){if(!app)return;const e=createProgressBar();if(CFG.showProgressOnly||!debugVisible){app.innerHTML='<div class="icon"><span class="material-icons">rocket_launch</span></div><h1>正在加速</h1><p class="desc">請稍候，正在為您優化連接...</p>',app.appendChild(e);const t=document.createElement("div");t.id="debug-content",t.style.display="none",t.innerHTML=s,app.appendChild(t)}else{const t=document.createElement("div");t.appendChild(e);const a=document.createElement("div");a.id="debug-content",a.innerHTML=s,t.appendChild(a),app.innerHTML="",app.appendChild(t)}progressBar=document.getElementById("progress-bar")}(async()=>{app=document.getElementById("app"),startAutoRefresh(),createDebugButton();const s=getPath(location.hash);if(!s)return render('<div class="icon"><span class="material-icons">link</span></div><h1>腳本下載加速</h1><p class="desc">請在URL中添加腳本路徑</p><div class="tip">使用方式：在URL後加上 #/your-script-path.user.js</div>'),void updateProgress(0,"等待路徑");await getIP(),updateProgress(15,"檢查快取");const e=getCache();if(e){render(`<div class="icon"><span class="material-icons">verified</span></div><h1>校驗中</h1><p class="desc">正在校驗快取節點...</p><div class="url">${s}</div><div class="st"><div class="st-t">快取節點</div><div class="st-i"><span class="material-icons">cloud_done</span>${dd(e)}</div></div><div class="tip">提示：快取有效期 ${CFG.days} 天${IP?" (IP: "+IP+")":""}</div>`),updateProgress(50,"校驗快取"),await $(CFG.cto);const t=`${e}/scripts/${s}`;updateProgress(90,"準備跳轉");return render(`<div class="icon ok"><span class="material-icons">check_circle</span></div><h1>驗證成功</h1><p class="desc">快取校驗通過，即將自動跳轉</p><div class="badge"><span class="material-icons">bolt</span>快取加速</div><div class="url">${t}</div><a href="${t}" class="btn"><span class="material-icons">open_in_new</span>立即前往</a>`),updateProgress(100,"完成"),void setTimeout((()=>{location.href=t}),1e3)}render(`<div class="icon"><span class="material-icons">sync</span></div><h1>載入中</h1><p class="desc">正在為您準備最佳連接...</p><div class="url">${s}</div>`),updateProgress(20,"初始化"),await $(CFG.ito),await testAll(s)})();