const D=["https://static-sg-apse1-primary-mirror-aws-s3-cloudfront-public-cdn.dahi.edu.eu.org","https://static-sg-apse1-primary-mirror-aws-s3-cloudfront-public-cdn.dahi.edu.eu.org.cdn.cloudflare.net","https://tencent.api-data-abtest-config.dahi.edu.eu.org","https://api-data-aws-abtest-config.dahi.edu.eu.org","https://abtest-ch-snssdk-os.netlify.app","https://api-data-abtest-config.dahi.edu.eu.org"],CFG={to:2e3,cnt:3,days:3,key:"gfork_fastest_domain",ipto:3e3,cto:2e3,ito:1e3};let R=[],IP=null,app=null;const scripts=[{id:"12345",name:"網頁廣告攔截助手",author:"AdBlocker",desc:"自動攔截網頁中的煩人廣告，讓瀏覽更清爽。支援主流影片網站、新聞網站等。",cat:"效率工具",dl:125600,rate:4.8,icon:"block"},{id:"23456",name:"影片下載器增強版",author:"VideoHelper",desc:"支援下載各大影片網站的內容，一鍵儲存到本地。支援批量下載和自訂畫質。",cat:"下載工具",dl:89300,rate:4.6,icon:"download"},{id:"34567",name:"自動填表助手",author:"FormFiller",desc:"智慧識別表單欄位，自動填入常用資訊。支援自訂範本，提高工作效率。",cat:"效率工具",dl:67800,rate:4.5,icon:"edit_note"},{id:"45678",name:"網頁翻譯增強",author:"TranslateMax",desc:"即時翻譯網頁內容，支援多種語言。劃詞翻譯、全文翻譯一應俱全。",cat:"學習工具",dl:156200,rate:4.9,icon:"translate"},{id:"56789",name:"GitHub增強工具",author:"GitHelper",desc:"為GitHub新增更多實用功能，包括程式碼樹、檔案下載、統計圖表等。",cat:"開發工具",dl:45600,rate:4.7,icon:"code"},{id:"67890",name:"購物比價助手",author:"PriceCompare",desc:"自動比較各大電商平台的商品價格，幫你找到最優惠的購買渠道。",cat:"購物優惠",dl:98700,rate:4.6,icon:"shopping_cart"},{id:"78901",name:"夜間模式增強",author:"DarkMode",desc:"為任何網站新增舒適的夜間模式，保護眼睛減少疲勞。支援自訂色彩方案。",cat:"美化工具",dl:112400,rate:4.8,icon:"dark_mode"},{id:"89012",name:"網盤加速下載",author:"SpeedUp",desc:"突破網盤下載速度限制，支援多執行緒下載。讓下載速度飛起來。",cat:"下載工具",dl:203500,rate:4.9,icon:"speed"}];let flt="全部",q="";const $=a=>new Promise((s=>setTimeout(s,a))),dd=a=>a.replace("https://",""),fmt=a=>a>=1e4?(a/1e4).toFixed(1)+"萬":a.toLocaleString();async function getIP(){try{const a=new AbortController,s=setTimeout((()=>a.abort()),CFG.ipto),t=await fetch("https://www.cloudflare.com/cdn-cgi/trace",{signal:a.signal});clearTimeout(s);const e=await t.text();for(const a of e.split("\n"))a.startsWith("ip=")&&(IP=a.split("=")[1].trim())}catch(a){}}function getPath(a){return a&&a.startsWith("#/")?a.substring(2):null}function getCache(){if(!IP)return null;try{const a=JSON.parse(localStorage.getItem(CFG.key)||"null");return!a||a.ip!==IP||Date.now()-a.time>864e5*CFG.days||!D.includes(a.domain)?(localStorage.removeItem(CFG.key),null):a.domain}catch{return null}}function setCache(a){if(IP)try{localStorage.setItem(CFG.key,JSON.stringify({ip:IP,domain:a,time:Date.now()}))}catch(a){}}async function testDomain(a){return new Promise((s=>{const t=document.createElement("iframe");t.style.display="none",t.sandbox="allow-scripts";const e=setTimeout((()=>{i(),s(!1)}),CFG.to);function i(){clearTimeout(e),t.parentNode&&document.body.removeChild(t)}const n=a=>{"gfork_activated"===a.data&&(i(),window.removeEventListener("message",n),s(!0))};window.addEventListener("message",n),t.srcdoc=`<!DOCTYPE html><html><head><script>window.gfork_test_active=false;window.onGforkActivated=function(){window.gfork_test_active=true;parent.postMessage('gfork_activated','*')};const s=document.createElement('script');s.src='${a}/gfork.js';s.onerror=()=>parent.postMessage('gfork_error','*');setTimeout(()=>{if(window.gfork_test_active)parent.postMessage('gfork_activated','*')},100);document.head.appendChild(s);<\/script></head></html>`,document.body.appendChild(t)}))}async function testAll(a){R=[];const s=[...D].sort((()=>Math.random()-.5)).slice(0,CFG.cnt);render(`<div class="icon"><span class="material-icons">speed</span></div><h1>測速中</h1><p class="desc">正在測試節點連接速度，請稍候...</p><div class="url">${a}</div><div class="st" id="st"><div class="st-t">測試節點 (${s.length}個)</div>${s.map((a=>`<div class="st-i" data-d="${a}"><span class="material-icons">pending</span>${dd(a)}<span class="lat">等待中</span></div>`)).join("")}</div><div class="tip">提示：正在隨機測試 ${CFG.cnt} 個節點</div>`);for(let a=0;a<s.length;a++){const t=s[a],e=document.querySelector(`[data-d="${t}"]`);e&&(e.className="st-i",e.innerHTML=`<span class="material-icons">sync</span>${dd(t)}<span class="lat">測試中...</span>`);const i=Date.now(),n=await testDomain(t),c=Date.now()-i;n?(R.push({d:t,lat:c}),e&&(e.className="st-i ok",e.innerHTML=`<span class="material-icons">check_circle</span>${dd(t)}<span class="lat">${c}ms</span>`)):e&&(e.className="st-i fail",e.innerHTML=`<span class="material-icons">cancel</span>${dd(t)}<span class="lat">超時</span>`),a<s.length-1&&await $(300)}if(R.length>0){R.sort(((a,s)=>a.lat-s.lat));const s=R[0];setCache(s.d),await $(500);const t=`${s.d}/scripts/${a}`;render(`<div class="icon ok"><span class="material-icons">check_circle</span></div><h1>驗證成功</h1><p class="desc">已選擇最快節點，即將自動跳轉</p><div class="badge"><span class="material-icons">speed</span>最低延遲 ${s.lat}ms</div><div class="url">${t}</div><div class="st"><div class="st-t">測速結果</div>${R.map(((a,s)=>`<div class="st-i ok"><span class="material-icons">${0===s?"emoji_events":"check_circle"}</span>${dd(a.d)}<span class="lat">${a.lat}ms</span></div>`)).join("")}</div><a href="${t}" class="btn"><span class="material-icons">open_in_new</span>立即前往</a>`),setTimeout((()=>{location.href=t}),1e3)}else{const s=`${D[Math.floor(Math.random()*D.length)]}/scripts/${a}`;render(`<div class="icon err"><span class="material-icons">warning</span></div><h1>使用備用方案</h1><p class="desc">所有節點檢測超時，已隨機選擇一個節點</p><div class="url">${s}</div><a href="${s}" class="btn"><span class="material-icons">open_in_new</span>手動前往</a><div class="tip">若無法訪問，請重新整理再試</div>`)}}function render(a){app&&(app.innerHTML=a)}function showList(){render(`<div class="hdr"><h1>使用者腳本中心</h1><p class="sub">發現並安裝實用的使用者腳本</p></div><div class="search"><span class="material-icons">search</span><input type="text" placeholder="搜尋腳本..." oninput="handleSearch(this.value)"></div><div class="tabs" id="tabs">${["全部",...new Set(scripts.map((a=>a.cat)))].map((a=>`<div class="tab${a===flt?" on":""}" onclick="handleFilter('${a}')">${a}</div>`)).join("")}</div><div class="grid" id="grid">${renderCards()}</div><div class="tip">提示：點擊任意腳本卡片即可查看詳情並安裝</div>`)}function renderCards(){let a=scripts;if("全部"!==flt&&(a=a.filter((a=>a.cat===flt))),q){const s=q.toLowerCase();a=a.filter((a=>a.name.toLowerCase().includes(s)||a.desc.toLowerCase().includes(s)||a.author.toLowerCase().includes(s)))}return 0===a.length?'<div class="empty"><span class="material-icons">search_off</span><h3>未找到相關腳本</h3><p>試試其他關鍵詞或分類</p></div>':a.map((a=>`<a href="#/${a.id}/${encodeURIComponent(a.name)}.user.js" class="card"><div class="card-h"><div class="card-ico"><span class="material-icons">${a.icon}</span></div><div class="card-info"><div class="card-name">${a.name}</div><div class="card-auth"><span class="material-icons">person</span>${a.author}</div></div></div><div class="card-desc">${a.desc}</div><div class="card-meta"><div><span class="material-icons">download</span>${fmt(a.dl)}</div><div><span class="material-icons">star</span>${a.rate}</div><div><span class="material-icons">label</span>${a.cat}</div></div></a>`)).join("")}function handleFilter(a){flt=a,document.querySelectorAll(".tab").forEach((s=>s.classList.toggle("on",s.textContent.trim()===a))),document.getElementById("grid").innerHTML=renderCards()}function handleSearch(a){q=a,document.getElementById("grid").innerHTML=renderCards()}(async()=>{app=document.getElementById("app");const a=getPath(location.hash);if(!a)return await $(100),void showList();await getIP();const s=getCache();if(s){render(`<div class="icon"><span class="material-icons">verified</span></div><h1>校驗中</h1><p class="desc">正在校驗快取節點...</p><div class="url">${a}</div><div class="st"><div class="st-t">快取節點</div><div class="st-i"><span class="material-icons">cloud_done</span>${dd(s)}</div></div><div class="tip">提示：快取有效期 ${CFG.days} 天${IP?" (IP: "+IP+")":""}</div>`),await $(CFG.cto);const t=`${s}/scripts/${a}`;return render(`<div class="icon ok"><span class="material-icons">check_circle</span></div><h1>驗證成功</h1><p class="desc">快取校驗通過，即將自動跳轉</p><div class="badge"><span class="material-icons">bolt</span>快取加速</div><div class="url">${t}</div><a href="${t}" class="btn"><span class="material-icons">open_in_new</span>立即前往</a>`),void setTimeout((()=>{location.href=t}),1e3)}render(`<div class="icon"><span class="material-icons">sync</span></div><h1>載入中</h1><p class="desc">正在為您準備最佳連接...</p><div class="url">${a}</div>`),await $(CFG.ito),await testAll(a)})();