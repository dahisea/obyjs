const D=["https://static-sg-apse1-primary-mirror-aws-s3-cloudfront-public-cdn.dahi.edu.eu.org","https://static-sg-apse1-primary-mirror-aws-s3-cloudfront-public-cdn.dahi.edu.eu.org.cdn.cloudflare.net","https://tencent.api-data-abtest-config.dahi.edu.eu.org","https://api-data-aws-abtest-config.dahi.edu.eu.org","https://abtest-ch-snssdk-os.netlify.app","https://api-data-abtest-config.dahi.edu.eu.org"],CFG={to:2e3,cnt:3,days:3,key:"gfork_fastest_domain",ipto:3e3,cto:2e3,ito:1e3};let R=[],IP=null,app=null;const $=s=>new Promise((a=>setTimeout(a,s))),dd=s=>s.replace("https://","");async function getIP(){try{const s=new AbortController,a=setTimeout((()=>s.abort()),CFG.ipto),t=await fetch("https://www.cloudflare.com/cdn-cgi/trace",{signal:s.signal});clearTimeout(a);const e=await t.text();for(const s of e.split("\n"))s.startsWith("ip=")&&(IP=s.split("=")[1].trim())}catch(s){}}function getPath(s){return s&&s.startsWith("#/")?s.substring(2):null}function getCache(){if(!IP)return null;try{const s=JSON.parse(localStorage.getItem(CFG.key)||"null");return!s||s.ip!==IP||Date.now()-s.time>864e5*CFG.days||!D.includes(s.domain)?(localStorage.removeItem(CFG.key),null):s.domain}catch{return null}}function setCache(s){if(IP)try{localStorage.setItem(CFG.key,JSON.stringify({ip:IP,domain:s,time:Date.now()}))}catch(s){}}async function testDomain(s){return new Promise((a=>{const t=document.createElement("iframe");t.style.display="none",t.sandbox="allow-scripts";const e=setTimeout((()=>{i(),a(!1)}),CFG.to);function i(){clearTimeout(e),t.parentNode&&document.body.removeChild(t)}const n=s=>{"gfork_activated"===s.data&&(i(),window.removeEventListener("message",n),a(!0))};window.addEventListener("message",n),t.srcdoc=`<!DOCTYPE html><html><head><script>window.gfork_test_active=false;window.onGforkActivated=function(){window.gfork_test_active=true;parent.postMessage('gfork_activated','*')};const s=document.createElement('script');s.src='${s}/gfork.js';s.onerror=()=>parent.postMessage('gfork_error','*');setTimeout(()=>{if(window.gfork_test_active)parent.postMessage('gfork_activated','*')},100);document.head.appendChild(s);<\/script></head></html>`,document.body.appendChild(t)}))}async function testAll(s){R=[];const a=[...D].sort((()=>Math.random()-.5)).slice(0,CFG.cnt);render(`<div class="icon"><span class="material-icons">speed</span></div><h1>測速中</h1><p class="desc">正在測試節點連接速度，請稍候...</p><div class="url">${s}</div><div class="st" id="st"><div class="st-t">測試節點 (${a.length}個)</div>${a.map((s=>`<div class="st-i" data-d="${s}"><span class="material-icons">pending</span>${dd(s)}<span class="lat">等待中</span></div>`)).join("")}</div><div class="tip">提示：正在隨機測試 ${CFG.cnt} 個節點</div>`);for(let s=0;s<a.length;s++){const t=a[s],e=document.querySelector(`[data-d="${t}"]`);e&&(e.className="st-i",e.innerHTML=`<span class="material-icons">sync</span>${dd(t)}<span class="lat">測試中...</span>`);const i=Date.now(),n=await testDomain(t),c=Date.now()-i;n?(R.push({d:t,lat:c}),e&&(e.className="st-i ok",e.innerHTML=`<span class="material-icons">check_circle</span>${dd(t)}<span class="lat">${c}ms</span>`)):e&&(e.className="st-i fail",e.innerHTML=`<span class="material-icons">cancel</span>${dd(t)}<span class="lat">超時</span>`),s<a.length-1&&await $(300)}if(R.length>0){R.sort(((s,a)=>s.lat-a.lat));const a=R[0];setCache(a.d),await $(500);const t=`${a.d}/scripts/${s}`;render(`<div class="icon ok"><span class="material-icons">check_circle</span></div><h1>驗證成功</h1><p class="desc">已選擇最快節點，即將自動跳轉</p><div class="badge"><span class="material-icons">speed</span>最低延遲 ${a.lat}ms</div><div class="url">${t}</div><div class="st"><div class="st-t">測速結果</div>${R.map(((s,a)=>`<div class="st-i ok"><span class="material-icons">${0===a?"emoji_events":"check_circle"}</span>${dd(s.d)}<span class="lat">${s.lat}ms</span></div>`)).join("")}</div><a href="${t}" class="btn"><span class="material-icons">open_in_new</span>立即前往</a>`),setTimeout((()=>{location.href=t}),1e3)}else{const a=`${D[Math.floor(Math.random()*D.length)]}/scripts/${s}`;render(`<div class="icon err"><span class="material-icons">warning</span></div><h1>使用備用方案</h1><p class="desc">所有節點檢測超時，已隨機選擇一個節點</p><div class="url">${a}</div><a href="${a}" class="btn"><span class="material-icons">open_in_new</span>手動前往</a><div class="tip">若無法訪問，請重新整理再試</div>`)}}function render(s){app&&(app.innerHTML=s)}(async()=>{app=document.getElementById("app");const s=getPath(location.hash);if(!s)return void render('<div class="icon"><span class="material-icons">link</span></div><h1>腳本下載加速</h1><p class="desc">請在URL中添加腳本路徑</p><div class="tip">使用方式：在URL後加上 #/your-script-path.user.js</div>');await getIP();const a=getCache();if(a){render(`<div class="icon"><span class="material-icons">verified</span></div><h1>校驗中</h1><p class="desc">正在校驗快取節點...</p><div class="url">${s}</div><div class="st"><div class="st-t">快取節點</div><div class="st-i"><span class="material-icons">cloud_done</span>${dd(a)}</div></div><div class="tip">提示：快取有效期 ${CFG.days} 天${IP?" (IP: "+IP+")":""}</div>`),await $(CFG.cto);const t=`${a}/scripts/${s}`;return render(`<div class="icon ok"><span class="material-icons">check_circle</span></div><h1>驗證成功</h1><p class="desc">快取校驗通過，即將自動跳轉</p><div class="badge"><span class="material-icons">bolt</span>快取加速</div><div class="url">${t}</div><a href="${t}" class="btn"><span class="material-icons">open_in_new</span>立即前往</a>`),void setTimeout((()=>{location.href=t}),1e3)}render(`<div class="icon"><span class="material-icons">sync</span></div><h1>載入中</h1><p class="desc">正在為您準備最佳連接...</p><div class="url">${s}</div>`),await $(CFG.ito),await testAll(s)})();