name: Obfuscate Web JavaScript

on:
  push:
    branches: [main, master]
    paths:
      - 'raw.js'
  pull_request:
    branches: [main, master]
    paths:
      - 'raw.js'
  workflow_dispatch:
    inputs:
      skip_commit:
        description: 'è·³è¿‡æäº¤æ›´æ”¹'
        required: false
        default: 'false'

jobs:
  obfuscate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package.json'
      
      - name: Create package.json and install javascript-obfuscator
        run: |
          # åˆ›å»ºåŸºæœ¬çš„ package.json æ–‡ä»¶
          if [ ! -f "package.json" ]; then
            cat > package.json << 'EOF'
            {
              "name": "js-obfuscator-workflow",
              "version": "1.0.0",
              "description": "JavaScript obfuscation workflow",
              "private": true,
              "devDependencies": {
                "javascript-obfuscator": "^4.1.1"
              },
              "scripts": {
                "obfuscate": "javascript-obfuscator raw.js --output y.js"
              }
            }
            EOF
            echo "Created package.json"
          fi
          
          # å®‰è£…ä¾èµ–å¹¶ç”Ÿæˆ package-lock.json
          npm install
          
          # æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "javascript-obfuscator version:"
          npx javascript-obfuscator --version
      
      - name: Verify raw.js exists
        run: |
          if [ ! -f "raw.js" ]; then
            echo "Error: raw.js not found!"
            echo "Available files:"
            ls -la
            exit 1
          fi
          
          echo "=== File Information ==="
          echo "raw.js size: $(wc -c < raw.js) bytes"
          echo "raw.js lines: $(wc -l < raw.js)"
          echo ""
      
      - name: Obfuscate raw.js to y.js
        id: obfuscate
        run: |
          echo "Starting obfuscation process..."
          echo "Input: raw.js"
          echo "Output: y.js"
          echo ""
          
          # è®°å½•å¼€å§‹æ—¶é—´
          START_TIME=$(date +%s)
          
          # è¿è¡Œæ··æ·†
          npx javascript-obfuscator raw.js --output y.js \
          --compact true \
          --control-flow-flattening true \
          --control-flow-flattening-threshold 0.2 \
          --dead-code-injection false \
          --identifier-names-generator mangled \
          --rename-globals false \
          --self-defending true \
          --debug-protection false \
          --debug-protection-interval false \
          --disable-console-output false \
          --string-array true \
          --string-array-encoding false \
          --string-array-threshold 0.6 \
          --string-array-indexes-type hexadecimal \
          --split-strings true \
          --split-strings-chunk-length 12 \
          --transform-object-keys false \
          --unicode-escape-sequence false \
          --reserved-names 'fetch,XMLHttpRequest,axios,document,window,localStorage,sessionStorage,console,JSON,Promise,setTimeout,setInterval,Date,Math,Object,Array,String,Number,Boolean,RegExp,Error' \
          --reserved-strings 'https://,http://,api/,Bearer,Authorization,Content-Type,application/json,multipart/form-data,text/plain,GET,POST,PUT,DELETE' \
          --domain-lock '' \
          --target 'browser' \
          --simplify true \
          --log false \
          --source-map false \
          --source-map-base-url '' \
          --source-map-file-name '' \
          --source-map-mode 'separate' \
          --force-transform-strings false \
          --numbers-to-expressions false
          
          # è®°å½•ç»“æŸæ—¶é—´
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo "::set-output name=duration::$DURATION"
          echo "::set-output name=status::success"
          
          echo ""
          echo "âœ“ Obfuscation completed in ${DURATION} seconds"
        
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
      
      - name: Validate obfuscated output
        run: |
          echo "=== Validating Output ==="
          
          if [ ! -f "y.js" ]; then
            echo "âŒ Error: y.js was not created!"
            exit 1
          fi
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
          if [ ! -s "y.js" ]; then
            echo "âŒ Error: y.js is empty!"
            exit 1
          fi
          
          # è·å–æ–‡ä»¶ä¿¡æ¯
          OBFUSCATED_SIZE=$(wc -c < y.js)
          OBFUSCATED_LINES=$(wc -l < y.js)
          ORIGINAL_SIZE=$(wc -c < raw.js)
          ORIGINAL_LINES=$(wc -l < raw.js)
          
          echo "Original:    $ORIGINAL_SIZE bytes, $ORIGINAL_LINES lines"
          echo "Obfuscated:  $OBFUSCATED_SIZE bytes, $OBFUSCATED_LINES lines"
          
          # è®¡ç®—å˜åŒ–ç™¾åˆ†æ¯”
          SIZE_INCREASE_PCT=$(echo "scale=2; ($OBFUSCATED_SIZE - $ORIGINAL_SIZE) * 100 / $ORIGINAL_SIZE" | bc)
          LINE_INCREASE_PCT=$(echo "scale=2; ($OBFUSCATED_LINES - $ORIGINAL_LINES) * 100 / $ORIGINAL_LINES" | bc)
          
          echo "Size change: $SIZE_INCREASE_PCT%"
          echo "Line change: $LINE_INCREASE_PCT%"
          echo ""
          
          # è¯­æ³•æ£€æŸ¥
          echo "Running JavaScript syntax check..."
          if node -c y.js; then
            echo "âœ“ y.js has valid JavaScript syntax"
          else
            echo "âŒ y.js has syntax errors"
            exit 1
          fi
          
          # æ£€æŸ¥æ–‡ä»¶å¤´éƒ¨
          echo ""
          echo "=== File Preview (first 5 lines) ==="
          head -5 y.js
      
      - name: Create comparison report
        run: |
          ORIGINAL_SIZE=$(wc -c < raw.js)
          OBFUSCATED_SIZE=$(wc -c < y.js)
          ORIGINAL_LINES=$(wc -l < raw.js)
          OBFUSCATED_LINES=$(wc -l < y.js)
          
          # è®¡ç®—ç™¾åˆ†æ¯”
          SIZE_INCREASE_PCT=$(echo "scale=2; ($OBFUSCATED_SIZE - $ORIGINAL_SIZE) * 100 / $ORIGINAL_SIZE" | bc)
          LINE_INCREASE_PCT=$(echo "scale=2; ($OBFUSCATED_LINES - $ORIGINAL_LINES) * 100 / $ORIGINAL_LINES" | bc)
          DURATION=${{ steps.obfuscate.outputs.duration }}
          
          echo "## ğŸ›¡ï¸ JavaScript Obfuscation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "**Processing Time:** ${DURATION} seconds" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“Š File Statistics" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | raw.js | y.js | Change |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Size** | $ORIGINAL_SIZE bytes | $OBFUSCATED_SIZE bytes | **+$SIZE_INCREASE_PCT%** |" >> $GITHUB_STEP_SUMMARY
          echo "| **Lines** | $ORIGINAL_LINES | $OBFUSCATED_LINES | **+$LINE_INCREASE_PCT%** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### âš™ï¸ Obfuscation Settings" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value | Purpose |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Control Flow Flattening | 0.2 threshold | Makes logic flow harder to follow |" >> $GITHUB_STEP_SUMMARY
          echo "| String Array | Enabled (0.6 threshold) | Extracts strings to array |" >> $GITHUB_STEP_SUMMARY
          echo "| String Splitting | Chunk length: 12 | Splits long strings into chunks |" >> $GITHUB_STEP_SUMMARY
          echo "| Self Defending | Enabled | Prevents code formatting/debugging |" >> $GITHUB_STEP_SUMMARY
          echo "| Target Environment | Browser | Optimized for web use |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ”’ Protected APIs" >> $GITHUB_STEP_SUMMARY
          echo "The following browser APIs were preserved (not renamed):" >> $GITHUB_STEP_SUMMARY
          echo "- **HTTP Requests:** fetch, XMLHttpRequest, axios" >> $GITHUB_STEP_SUMMARY
          echo "- **DOM APIs:** document, window" >> $GITHUB_STEP_SUMMARY
          echo "- **Storage:** localStorage, sessionStorage" >> $GITHUB_STEP_SUMMARY
          echo "- **Core Objects:** JSON, Promise, Date, Math" >> $GITHUB_STEP_SUMMARY
          echo "- **Debugging:** console (preserved for error handling)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“ Files" >> $GITHUB_STEP_SUMMARY
          echo "- **Input:** [raw.js](${{ github.server_url }}/${{ github.repository }}/blob/${{ github.sha }}/raw.js)" >> $GITHUB_STEP_SUMMARY
          echo "- **Output:** [y.js](${{ github.server_url }}/${{ github.repository }}/blob/${{ github.sha }}/y.js)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸš€ Quick Test" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Test if the file is valid JavaScript" >> $GITHUB_STEP_SUMMARY
          echo "node -c y.js" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: Commit changes
        if: github.event_name == 'push' && github.event.inputs.skip_commit != 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          echo "Checking for changes..."
          git status
          
          # æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶
          git add y.js package.json package-lock.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            # è·å–æ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯
            ORIGINAL_SIZE=$(wc -c < raw.js)
            OBFUSCATED_SIZE=$(wc -c < y.js)
            SIZE_INCREASE_PCT=$(echo "scale=1; ($OBFUSCATED_SIZE - $ORIGINAL_SIZE) * 100 / $ORIGINAL_SIZE" | bc)
            
            git commit -m "ğŸ”’ chore: obfuscate raw.js to y.js

            Obfuscation Details:
            - Size: ${ORIGINAL_SIZE} bytes â†’ ${OBFUSCATED_SIZE} bytes (+${SIZE_INCREASE_PCT}%)
            - Target: Browser environment
            - Protection: Self-defending enabled
            - Preserved browser APIs for compatibility
            
            Generated by GitHub Actions workflow"
            
            echo "Pushing changes..."
            git pull --rebase origin ${{ github.ref_name }}
            git push origin HEAD:${{ github.ref_name }}
            echo "âœ… Changes committed and pushed"
          fi
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: obfuscated-javascript
          path: |
            y.js
            package.json
            package-lock.json
          retention-days: 7
          if-no-files-found: error
      
      - name: Clean up (optional)
        if: always()
        run: |
          echo "Cleaning up temporary files..."
          # å¯ä»¥æ·»åŠ æ¸…ç†æ­¥éª¤ï¼Œä½†å°å¿ƒä¸è¦åˆ é™¤é‡è¦æ–‡ä»¶
          echo "Current directory contents:"
          ls -la
