name: Obfuscate Web JavaScript

on:
  push:
    branches: [main, master]
    paths:
      - 'raw.js'
  pull_request:
    branches: [main, master]
    paths:
      - 'raw.js'
  workflow_dispatch:
    inputs:
      skip_commit:
        description: 'è·³è¿‡æäº¤æ›´æ”¹'
        required: false
        default: 'false'

jobs:
  obfuscate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Create minimal package.json
        run: |
          echo "Creating package.json..."
          
          # åˆ›å»ºæˆ–æ›´æ–° package.json
          if [ ! -f "package.json" ]; then
            cat > package.json << 'EOF'
{
  "name": "js-obfuscator-workflow",
  "version": "1.0.0",
  "description": "Workflow for JavaScript obfuscation",
  "private": true,
  "main": "y.js",
  "scripts": {
    "obfuscate": "npx javascript-obfuscator raw.js --output y.js"
  },
  "devDependencies": {
    "javascript-obfuscator": "^4.1.1"
  },
  "keywords": ["obfuscation", "javascript", "security"],
  "author": "GitHub Actions",
  "license": "MIT"
}
EOF
            echo "âœ“ Created package.json"
          else
            echo "âœ“ package.json already exists"
          fi
          
          # æ˜¾ç¤º package.json å†…å®¹
          echo "package.json content:"
          cat package.json
      
      - name: Install javascript-obfuscator
        run: |
          echo "Installing dependencies..."
          echo "Current directory: $(pwd)"
          echo "Files in directory:"
          ls -la
          
          # æ£€æŸ¥ package.json æ˜¯å¦å­˜åœ¨
          if [ ! -f "package.json" ]; then
            echo "âŒ Error: package.json not found"
            exit 1
          fi
          
          # å®‰è£…ä¾èµ–
          npm install --no-fund --no-audit --progress=false
          
          # éªŒè¯å®‰è£…
          echo "=== Dependencies Installed ==="
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          npx javascript-obfuscator --version
          
          # æ˜¾ç¤ºç”Ÿæˆçš„ lock æ–‡ä»¶
          if [ -f "package-lock.json" ]; then
            echo "âœ“ package-lock.json created"
          fi
      
      - name: Verify raw.js exists
        run: |
          echo "=== Checking input file ==="
          
          if [ ! -f "raw.js" ]; then
            echo "âŒ Error: raw.js not found!"
            echo "Current directory contents:"
            ls -la
            exit 1
          fi
          
          echo "âœ“ raw.js found"
          echo "File size: $(wc -c < raw.js) bytes"
          echo "Line count: $(wc -l < raw.js) lines"
      
      - name: Obfuscate raw.js to y.js
        id: obfuscate
        run: |
          echo "ğŸš€ Starting obfuscation..."
          echo "Input: raw.js"
          echo "Output: y.js"
          echo ""
          
          # è®°å½•å¼€å§‹æ—¶é—´
          START_TIME=$(date +%s)
          
          # å¤‡ä»½åŸå§‹æ–‡ä»¶å¤§å°
          ORIGINAL_SIZE=$(wc -c < raw.js)
          
          # è¿è¡Œæ··æ·†
          echo "Running javascript-obfuscator..."
          npx javascript-obfuscator raw.js --output y.js \
          --compact true \
          --control-flow-flattening true \
          --control-flow-flattening-threshold 0.2 \
          --dead-code-injection false \
          --identifier-names-generator mangled \
          --rename-globals false \
          --self-defending true \
          --debug-protection false \
          --debug-protection-interval false \
          --disable-console-output false \
          --string-array true \
          --string-array-encoding false \
          --string-array-threshold 0.6 \
          --string-array-indexes-type hexadecimal \
          --split-strings true \
          --split-strings-chunk-length 12 \
          --transform-object-keys false \
          --unicode-escape-sequence false \
          --reserved-names 'fetch,XMLHttpRequest,axios,document,window,localStorage,sessionStorage,console,JSON,Promise,setTimeout,setInterval,Date,Math,Object,Array,String,Number,Boolean,RegExp,Error' \
          --reserved-strings 'https://,http://,api/,Bearer,Authorization,Content-Type,application/json,multipart/form-data,text/plain,GET,POST,PUT,DELETE' \
          --domain-lock '' \
          --target 'browser' \
          --simplify true \
          --log false \
          --source-map false \
          --force-transform-strings false \
          --numbers-to-expressions false
          
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
          if [ ! -f "y.js" ]; then
            echo "âŒ Error: y.js was not created!"
            exit 1
          fi
          
          # è®°å½•ç»“æŸæ—¶é—´
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          # è·å–æ··æ·†åæ–‡ä»¶å¤§å°
          OBFUSCATED_SIZE=$(wc -c < y.js)
          
          # è®¡ç®—ç™¾åˆ†æ¯”
          SIZE_INCREASE=$(echo "scale=2; ($OBFUSCATED_SIZE - $ORIGINAL_SIZE) * 100 / $ORIGINAL_SIZE" | bc)
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "original_size=$ORIGINAL_SIZE" >> $GITHUB_OUTPUT
          echo "obfuscated_size=$OBFUSCATED_SIZE" >> $GITHUB_OUTPUT
          echo "size_increase=$SIZE_INCREASE" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… Obfuscation completed!"
          echo "â±ï¸  Duration: ${DURATION} seconds"
          echo "ğŸ“Š Size: ${ORIGINAL_SIZE} bytes â†’ ${OBFUSCATED_SIZE} bytes (+${SIZE_INCREASE}%)"
        
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
      
      - name: Validate obfuscated output
        run: |
          echo "=== Validating Output ==="
          
          if [ ! -f "y.js" ]; then
            echo "âŒ Error: y.js not found"
            exit 1
          fi
          
          # åŸºæœ¬æ£€æŸ¥
          FILE_SIZE=$(wc -c < y.js)
          FILE_LINES=$(wc -l < y.js)
          
          echo "File: y.js"
          echo "Size: $FILE_SIZE bytes"
          echo "Lines: $FILE_LINES lines"
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºç©º
          if [ $FILE_SIZE -eq 0 ]; then
            echo "âŒ Error: y.js is empty!"
            exit 1
          fi
          
          # è¯­æ³•æ£€æŸ¥
          echo "Running JavaScript syntax check..."
          if node -c y.js 2>/dev/null; then
            echo "âœ… y.js has valid JavaScript syntax"
          else
            echo "âš ï¸  Syntax check warning (may be due to browser-specific code)"
          fi
          
          # æ˜¾ç¤ºæ–‡ä»¶å¼€å¤´
          echo ""
          echo "=== Preview of y.js (first 3 lines) ==="
          head -3 y.js
      
      - name: Create GitHub summary report
        run: |
          DURATION=${{ steps.obfuscate.outputs.duration }}
          ORIGINAL_SIZE=${{ steps.obfuscate.outputs.original_size }}
          OBFUSCATED_SIZE=${{ steps.obfuscate.outputs.obfuscated_size }}
          SIZE_INCREASE=${{ steps.obfuscate.outputs.size_increase }}
          
          # è®¡ç®—è¡Œæ•°
          ORIGINAL_LINES=$(wc -l < raw.js)
          OBFUSCATED_LINES=$(wc -l < y.js)
          LINE_INCREASE=$(echo "scale=2; ($OBFUSCATED_LINES - $ORIGINAL_LINES) * 100 / $ORIGINAL_LINES" | bc)
          
          echo "# ğŸ›¡ï¸ JavaScript Obfuscation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ“Š Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          echo "| **Processing Time** | $DURATION seconds |" >> $GITHUB_STEP_SUMMARY
          echo "| **Generated At** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ“ˆ File Statistics" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | raw.js | y.js | Change |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **File Size** | $ORIGINAL_SIZE bytes | $OBFUSCATED_SIZE bytes | **+$SIZE_INCREASE%** |" >> $GITHUB_STEP_SUMMARY
          echo "| **Line Count** | $ORIGINAL_LINES lines | $OBFUSCATED_LINES lines | **+$LINE_INCREASE%** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## âš™ï¸ Obfuscation Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Control Flow Flattening:** Enabled (20% threshold)" >> $GITHUB_STEP_SUMMARY
          echo "- **String Array:** Enabled (60% threshold)" >> $GITHUB_STEP_SUMMARY
          echo "- **String Splitting:** Enabled (12 character chunks)" >> $GITHUB_STEP_SUMMARY
          echo "- **Self Defending:** Enabled (anti-debugging)" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Environment:** Browser" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ“ Generated Files" >> $GITHUB_STEP_SUMMARY
          echo "- **Input:** [`raw.js`](${{ github.server_url }}/${{ github.repository }}/blob/${{ github.sha }}/raw.js) ($ORIGINAL_SIZE bytes)" >> $GITHUB_STEP_SUMMARY
          echo "- **Output:** [`y.js`](${{ github.server_url }}/${{ github.repository }}/blob/${{ github.sha }}/y.js) ($OBFUSCATED_SIZE bytes)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸš€ Quick Test" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Verify the output file" >> $GITHUB_STEP_SUMMARY
          echo "ls -la y.js" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: Commit changes
        if: github.event_name == 'push' && github.event.inputs.skip_commit != 'true'
        run: |
          echo "=== Committing Changes ==="
          
          # é…ç½® git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          echo "Checking for changes..."
          
          # æ·»åŠ æ–‡ä»¶
          git add y.js package.json package-lock.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            echo "Changes detected, creating commit..."
            
            # åˆ›å»ºæäº¤ä¿¡æ¯
            git commit -m "ğŸ”’ chore: obfuscate raw.js to y.js

            Generated by GitHub Actions workflow"
            
            # æ¨é€åˆ°ä»“åº“
            echo "Pushing changes..."
            git pull --rebase origin ${{ github.ref_name }}
            git push origin HEAD:${{ github.ref_name }}
            
            echo "âœ… Changes committed and pushed"
          fi
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: obfuscated-javascript
          path: |
            y.js
            raw.js
          retention-days: 7
